<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate Fretboard Trainer v9.5</title>
    <style>
        /* --- CSS VARIABLES --- */
        :root {
            --bg-color: #f8fafc;
            --text-color: #0f172a;
            --panel-bg: #ffffff;
            --panel-shadow: rgba(0,0,0,0.08);
            --fretboard-bg: #3d2616;
            --fretboard-border: #1a1008;
            --string-color: #a3a3a3;
            --fret-wire: #bdafa6;
            --nut-color: #e2e8f0; 
            --marker-color: #f1f5f9;
            --highlight-blue: #3b82f6;
            --highlight-orange: #f97316;
            --highlight-green: #10b981;
            --highlight-yellow: #facc15;
            
            --nav-btn-bg: #e2e8f0;
            --nav-btn-text: #475569;
            --nav-btn-hover: #cbd5e1;

            --theory-bg: #fffbeb;
            --theory-border: #fcd34d;
            --theory-text: #78350f;
            
            --cof-ring-color: #e0e0e0;
            --cof-wedge-bg: #f7f7f7;
            --cof-border: #4a4a4a;
            --timer-color: #dc2626;
            --stats-bg: #ecfeff; 
            --stats-border: #06b6d4;
            --slot-bg: #f1f5f9;
        }

        body.dark-mode {
            --bg-color: #0f172a;
            --text-color: #f1f5f9;
            --panel-bg: #1e293b;
            --panel-shadow: rgba(0,0,0,0.4);
            --fretboard-bg: #271a12;
            --fretboard-border: #000000;
            --string-color: #64748b;
            --fret-wire: #475569;
            --nut-color: #334155; 
            --marker-color: #64748b;
            
            --nav-btn-bg: #334155;
            --nav-btn-text: #cbd5e1;
            --nav-btn-hover: #475569;

            --theory-bg: #451a03;
            --theory-border: #d97706;
            --theory-text: #fef3c7;
            
            --cof-ring-color: #374151;
            --cof-wedge-bg: #1f2937;
            --cof-border: #9ca3af;
            --timer-color: #ef4444;
            --stats-bg: #0f172a; 
            --stats-border: #0891b2;
            --slot-bg: #334151;
        }

        /* --- CORE LAYOUT --- */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0 0 40px 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            text-align: center;
            transition: background-color 0.3s, color 0.3s;
        }

        /* --- TOP NAVIGATION BAR --- */
        #top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            background-color: var(--panel-bg);
            box-shadow: 0 1px 3px var(--panel-shadow);
            margin-bottom: 20px;
        }

        .nav-group { display: flex; gap: 10px; }

        .icon-btn {
            background-color: var(--nav-btn-bg);
            color: var(--nav-btn-text);
            border: none;
            border-radius: 50%;
            width: 45px; height: 45px;
            font-size: 1.5rem;
            cursor: pointer;
            display: flex; justify-content: center; align-items: center;
            transition: all 0.2s ease;
            box-shadow: none; /* Override default button shadow */
        }
        .icon-btn:hover { background-color: var(--nav-btn-hover); transform: scale(1.05); }
        .icon-btn.active { background-color: var(--highlight-blue); color: white; box-shadow: 0 0 10px var(--highlight-blue); }

        /* --- HEADER --- */
        h1 { margin: 10px 0 5px 0; font-size: 2.2rem; letter-spacing: -1px; }

        /* --- CONTROLS CONTAINER --- */
        .controls-wrapper {
            background: var(--panel-bg);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 6px var(--panel-shadow);
            margin: 0 auto 20px auto;
            display: inline-block;
            max-width: 1000px;
            width: 90%;
        }

        .controls-group {
            display: flex; flex-wrap: wrap; justify-content: center;
            gap: 10px; margin-bottom: 10px;
        }
        .controls-group.settings-filters {
             border-top: 1px solid var(--fret-wire);
             padding-top: 15px; margin-top: 10px;
        }

        /* --- SETTINGS GROUPS --- */
        .setting-group {
            display: flex; flex-direction: column; align-items: flex-start;
            padding: 8px 12px;
            border: 1px solid var(--fretboard-border);
            border-radius: 8px;
            background-color: var(--bg-color);
            font-size: 0.9rem;
        }
        .checkbox-group, .radio-group { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 5px; }
        
        select {
            padding: 5px; font-size: 1rem; border-radius: 6px;
            border: 1px solid #94a3b8; background-color: var(--panel-bg);
            color: var(--text-color); cursor: pointer;
        }
        
        /* --- MAIN BUTTONS --- */
        .mode-btn {
            padding: 12px 20px; font-size: 1rem; font-weight: 700; cursor: pointer;
            border: none; border-radius: 8px; background-color: #3b82f6; color: white;
            transition: all 0.2s; box-shadow: 0 4px 0 #1d4ed8; margin-bottom: 5px;
        }
        .mode-btn:active { transform: translateY(4px); box-shadow: none; }
        .mode-btn:hover { filter: brightness(110%); }

        /* Button Colors */
        .btn-green { background-color: #10b981; box-shadow: 0 4px 0 #047857; } 
        .btn-orange { background-color: #f59e0b; box-shadow: 0 4px 0 #d97706; } 
        .btn-pink { background-color: #ec4899; box-shadow: 0 4px 0 #be185d; } 
        .btn-teal { background-color: #14b8a6; box-shadow: 0 4px 0 #0f766e; }
        .btn-red { background-color: #dc2626; box-shadow: 0 4px 0 #991b1b; } 
        .btn-purple { background-color: #8b5cf6; box-shadow: 0 4px 0 #7c3aed; }
        .btn-dark { background-color: #334155; box-shadow: 0 4px 0 #0f172a; }

        /* --- THEORY CARD --- */
        #theory-panel {
            display: none; width: 90%; max-width: 800px; margin: 0 auto 20px auto;
            background-color: var(--theory-bg);
            border-left: 5px solid var(--theory-border);
            border-radius: 8px; padding: 20px; text-align: left;
            box-shadow: 0 4px 6px var(--panel-shadow);
            color: var(--theory-text);
        }
        #theory-panel h3 { margin-top: 0; display: flex; align-items: center; gap: 10px; }
        .theory-section { margin-bottom: 15px; }
        .theory-label { font-weight: 800; text-transform: uppercase; font-size: 0.75rem; opacity: 0.8; display: block; margin-bottom: 4px; }
        
        /* --- QUESTION AREA --- */
        #target-note-display {
            font-size: 4em; font-weight: 900;
            margin: 10px 0; color: var(--text-color); 
            text-shadow: 2px 2px 0px var(--panel-shadow);
            line-height: 1;
        }
        
        #message-display {
            font-size: 1.2em; font-weight: 600; 
            margin: 0 0 20px 0; color: #64748b; min-height: 1.5em;
        }

        /* --- HUD --- */
        #action-bar {
            display: flex; justify-content: center; align-items: center; flex-wrap: wrap; gap: 15px;
            margin: 10px auto 30px auto; padding: 10px; background-color: var(--panel-bg);
            border-radius: 12px; box-shadow: 0 2px 4px var(--panel-shadow); max-width: 900px;
        }

        .hud-item, .stat-hud-item {
            font-weight: 700; color: var(--text-color); background: var(--bg-color);
            padding: 8px 15px; border-radius: 6px; border: 1px solid var(--fretboard-border);
        }
        .stat-hud-item { background: var(--stats-bg); border-color: var(--stats-border); display: flex; gap: 15px; }
        .stat-block { display: flex; flex-direction: column; align-items: center; line-height: 1; }
        .stat-value { font-size: 1.1em; font-weight: 900; color: var(--highlight-blue); }
        #timer-display { color: var(--timer-color); font-size: 1.8em; font-weight: 900; min-width: 50px; }

        /* --- KEY BUILDER (FIXED LAYOUT) --- */
        #key-builder-wrapper { display: none; flex-direction: column; align-items: center; width: 100%; margin-bottom: 20px; }
        
        #kb-slots {
            display: flex; 
            flex-wrap: nowrap; /* Forces single row */
            gap: 8px; 
            justify-content: center;
            width: 100%; max-width: 900px;
            overflow-x: auto; /* Safety scroll for tiny screens */
            padding-bottom: 5px;
        }
        
        .kb-slot {
            flex: 1; /* Grow evenly */
            min-width: 45px; max-width: 80px; height: 85px;
            background-color: var(--slot-bg);
            border: 2px solid var(--fretboard-border);
            border-radius: 8px;
            display: flex; flex-direction: column;
            justify-content: space-between; align-items: center;
            padding: 5px 2px;
            font-weight: bold; color: var(--text-color);
            transition: all 0.2s;
        }
        .kb-degree { font-size: 0.8em; opacity: 0.7; }
        .kb-note { font-size: 1.6em; font-weight: 900; margin-top: 10px; }
        
        .kb-slot.filled { background-color: #dbeafe; border-color: var(--highlight-blue); }
        .kb-slot.correct-reveal { background-color: var(--highlight-green); border-color: var(--highlight-green); color: white; }
        .kb-slot.correct-reveal .kb-note { color: white; }

        .kb-slot.active-target { border-color: var(--highlight-orange); box-shadow: 0 0 8px var(--highlight-orange); transform: translateY(-3px); }

        /* --- MULTIPLE CHOICE GRID --- */
        #mc-options {
            display: none; 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(60px, 1fr)); 
            gap: 10px;
            padding: 0 10px 20px 10px; margin: 0 auto; max-width: 700px; 
            justify-content: center;
        }

        .mc-button {
            padding: 10px 5px; font-size: 1.5em; font-weight: 900;
            border-radius: 10px; box-shadow: 0 4px 0 var(--fretboard-bg);
            background-color: var(--fret-wire); color: var(--text-color); border: none;
            min-height: 60px; cursor: pointer; position: relative;
        }
        .mc-button:active { transform: translateY(4px); box-shadow: none; }
        
        .mc-button.correct-answer { background-color: var(--highlight-blue); color: white; }
        .mc-button.wrong-answer { background-color: var(--highlight-orange); color: white; }
        .mc-button.revealed-answer { background-color: var(--highlight-green); color: white; }
        
        /* Key Builder States */
        .mc-button.kb-selected { background-color: var(--highlight-blue); color: white; top: 4px; box-shadow: none; } 
        .mc-button.kb-right { background-color: var(--highlight-green); color: white; } 
        .mc-button.kb-wrong { background-color: var(--highlight-orange); color: white; } 
        .mc-button.kb-missed { background-color: var(--highlight-yellow); color: black; border: 2px dashed black; }
        
        /* Hint Pulse Animation */
        @keyframes pulse-hint {
            0% { box-shadow: 0 0 0 0 rgba(234, 88, 12, 0.7); border: 2px solid var(--highlight-orange); transform: scale(1); }
            50% { box-shadow: 0 0 0 10px rgba(234, 88, 12, 0); border: 2px solid var(--highlight-orange); transform: scale(1.1); }
            100% { box-shadow: 0 0 0 0 rgba(234, 88, 12, 0); border: 2px solid var(--highlight-orange); transform: scale(1); }
        }
        .hint-active { animation: pulse-hint 1.5s infinite; z-index: 10; }

        /* --- FRETBOARD --- */
        #fretboard-wrapper {
            display: flex; justify-content: center; margin-top: 10px;
            overflow-x: auto; padding-bottom: 20px;
        }

        #fretboard-container {
            background-color: var(--fretboard-bg);
            border: 4px solid var(--fretboard-border);
            padding: 0; border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            display: inline-block; position: relative;
        }
        
        #fretboard { display: grid; grid-auto-flow: column; white-space: nowrap; }

        .fret-column { display: grid; grid-template-rows: repeat(6, 40px); width: 50px; border-right: 2px solid var(--fret-wire); position: relative; }
        .nut-column { width: 35px; background-color: var(--nut-color); border-right: 5px solid #666; display: grid; grid-template-rows: repeat(6, 40px); }
        .marker { position: absolute; background-color: var(--marker-color); border-radius: 50%; left: 50%; transform: translateX(-50%); pointer-events: none; }
        .single-marker { width: 14px; height: 14px; top: 120px; margin-top: -7px; }
        .double-marker-top { width: 14px; height: 14px; top: 60px; margin-top: -7px; }
        .double-marker-bottom { width: 14px; height: 14px; top: 180px; margin-top: -7px; }
        
        .string-cell { width: 100%; height: 40px; display: flex; justify-content: center; align-items: center; position: relative; border-bottom: 1px solid rgba(0,0,0,0.2); }
        .string-line { position: absolute; top: 50%; left: 0; right: 0; background-color: var(--string-color); transform: translateY(-50%); z-index: 2; height: 2px; }
        .string-0 .string-line, .string-1 .string-line { height: 1px; }
        .string-4 .string-line, .string-5 .string-line { height: 3px; }
        
        .note-spot { 
            width: 32px; height: 32px; background-color: transparent; border-radius: 50%; 
            position: relative; z-index: 10; cursor: pointer; 
            display: flex; justify-content: center; align-items: center; 
            font-size: 1rem; font-weight: 900; color: white; 
            border: 2px solid transparent; transition: transform 0.1s; 
        }
        .nut-column .note-spot { color: var(--text-color); }
        .note-spot:hover { background-color: rgba(255,255,255,0.2); transform: scale(1.15); }
        
        .correct { background-color: var(--highlight-blue) !important; border: 2px solid white; box-shadow: 0 0 10px var(--highlight-blue); }
        .incorrect { background-color: var(--highlight-orange) !important; border: 2px solid white; }
        .revealed { background-color: var(--highlight-yellow) !important; color: black !important; border: 2px solid black; }
        .sequence-correct { background-color: #9333ea !important; border: 2px solid white; }
        
        /* Hint Logic for Fretboard */
        .hint-marker { background-color: rgba(255, 255, 255, 0.3); border: 2px dashed var(--highlight-yellow); }
        
        /* --- COF --- */
        #cof-wrapper { display: none; justify-content: center; margin: 40px auto; max-width: 600px; }
        .cof-ring { position: relative; width: 350px; height: 350px; border-radius: 50%; background: var(--cof-ring-color); box-shadow: 0 4px 15px var(--panel-shadow); }
        .cof-wedge-container { position: absolute; top: 50%; left: 50%; width: 50%; height: 50%; transform-origin: 0% 0%; pointer-events: none; overflow: hidden; }
        .cof-wedge { position: absolute; width: 200%; height: 200%; top: -100%; left: -100%; transform-origin: 100% 100%; cursor: pointer; pointer-events: auto; background-color: var(--cof-wedge-bg); border-radius: 400px; border: 1px solid var(--cof-border); clip-path: polygon(100% 100%, 0% 100%, 100% 0%); }
        .cof-wedge:hover { opacity: 0.9; filter: brightness(1.1); }
        .cof-note-label { position: absolute; font-size: 1.2em; font-weight: 900; color: var(--text-color); top: 20px; left: 20px; transform-origin: 0 0; pointer-events: none; }
        .cof-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 130px; height: 130px; background: var(--fretboard-bg); border-radius: 50%; z-index: 20; display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; box-shadow: 0 0 10px rgba(0,0,0,0.5); }
        .cof-center-note { font-size: 2em; font-weight: 900; }
        .cof-correct { background-color: var(--highlight-blue) !important; }
        .cof-incorrect { background-color: var(--highlight-orange) !important; }
        .cof-hint { background-color: rgba(250, 204, 21, 0.5) !important; border: 2px dashed yellow !important; }

    </style>
</head>
<body class="dark-mode"> <nav id="top-bar">
        <div class="nav-group">
            <button id="theory-btn" class="icon-btn" onclick="toggleTheory()" title="Toggle Theory Lesson">üìñ</button>
            <button id="hint-btn" class="icon-btn" onclick="toggleHintMode()" title="Toggle Hints">‚ùì</button>
        </div>
        <div class="nav-group">
            <button id="theme-btn" class="icon-btn" onclick="toggleTheme()" title="Toggle Light/Dark Mode">üåë</button>
        </div>
    </nav>

    <header id="header">
        <h1>Ultimate Fretboard Trainer</h1>
        
        <div id="theory-panel">
            <h3>üìñ <span id="theory-title">Theory Lesson</span></h3>
            <div class="theory-section">
                <span class="theory-label">The Concept</span>
                <span id="theory-concept"></span>
            </div>
            <div class="theory-section">
                <span class="theory-label">Pro Strategy</span>
                <span id="theory-strategy"></span>
            </div>
        </div>

        <div class="controls-wrapper">
            <div class="controls-group quiz-modes">
                <button class="mode-btn" onclick="startQuiz('single')">Find Note</button>
                <button class="mode-btn btn-teal" onclick="startQuiz('name')">Name Note</button>
                <button class="mode-btn" onclick="startQuiz('all')">Find All</button>
                <button class="mode-btn btn-purple" onclick="startQuiz('chord')">Chords</button>
                <button class="mode-btn" onclick="startQuiz('scale')">Fretboard Scale</button>
                <button class="mode-btn btn-pink" onclick="startQuiz('key_builder')">üîë Key Builder</button>
                <button class="mode-btn btn-orange" onclick="startQuiz('cof')">‚≠ï Circle of Fifths</button>
                <button class="mode-btn btn-green" onclick="startQuiz('free')">üé∏ Free Play</button>
            </div>

            <div class="controls-group settings-filters">
                
                <div class="setting-group" id="tuning-setting">
                    <label><strong>Tuning</strong></label>
                    <select id="tuning-select" onchange="changeSetting()">
                        <option value="standard">Standard</option>
                        <option value="drop_d">Drop D</option>
                        <option value="dadgad">DADGAD</option>
                        <option value="open_g">Open G</option>
                    </select>
                </div>

                <div class="setting-group" id="frets-setting">
                    <label><strong>Range</strong></label>
                    <select id="range-select" onchange="changeSetting()">
                        <option value="12" selected>0 - 12</option>
                        <option value="24">0 - 24</option>
                    </select>
                </div>
                
                <div class="setting-group filter-group" id="timer-setting" style="display:none;">
                    <label><strong>Timer</strong></label>
                    <select id="timer-select" onchange="resetTimer()">
                        <option value="0">Off</option>
                        <option value="5">5s</option>
                        <option value="10">10s</option>
                        <option value="15">15s</option>
                    </select>
                </div>

                <div class="setting-group filter-group" id="chord-filters" style="display:none;">
                    <label><strong>Chord Type</strong></label>
                    <div class="checkbox-group">
                        <input type="checkbox" id="chord_maj" value="Maj" checked><label for="chord_maj">Major</label>
                        <input type="checkbox" id="chord_min" value="Min" checked><label for="chord_min">Minor</label>
                        <input type="checkbox" id="chord_7" value="7" checked><label for="chord_7">Dom7</label>
                    </div>
                </div>

                <div class="setting-group filter-group" id="scale-filters" style="display:none;">
                    <label><strong>Scale Type</strong></label>
                    <div class="radio-group">
                        <input type="radio" name="scale_type" id="scale_major" value="Major" checked><label for="scale_major">Major</label>
                        <input type="radio" name="scale_type" id="scale_minor" value="Minor"><label for="scale_minor">Nat. Minor</label>
                    </div>
                </div>
                
                <div class="setting-group filter-group" id="name-note-string-filters" style="display:none;">
                    <label><strong>Focus Strings</strong></label>
                    <div class="checkbox-group">
                        <input type="checkbox" id="string_5" data-s="5" checked><label>E</label>
                        <input type="checkbox" id="string_4" data-s="4" checked><label>A</label>
                        <input type="checkbox" id="string_3" data-s="3" checked><label>D</label>
                        <input type="checkbox" id="string_2" data-s="2" checked><label>G</label>
                        <input type="checkbox" id="string_1" data-s="1" checked><label>B</label>
                        <input type="checkbox" id="string_0" data-s="0" checked><label>e</label>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div id="target-note-display">Select a Mode</div>
    <p id="message-display">Choose a quiz type above.</p>
    
    <div id="action-bar">
        <div class="hud-item">
            Streak: <span id="streak-display" style="color:var(--highlight-blue)">0</span> üî•
        </div>
        
        <div class="stat-hud-item">
            <div class="stat-block">
                <span style="font-size:0.6em; opacity:0.8">ACCURACY</span>
                <span id="stat-accuracy" class="stat-value">--%</span>
            </div>
            <div class="stat-block">
                <span style="font-size:0.6em; opacity:0.8">SPEED</span>
                <span id="stat-speed" class="stat-value">--s</span>
            </div>
            <button id="reset-stats-btn" onclick="resetStats()" style="background:none; border:none; cursor:pointer;" title="Reset">üîÑ</button>
        </div>

        <button class="mode-btn btn-purple" id="replay-btn" style="display:none" onclick="replayTargetTone()">üîä Hear Note</button>
        <button class="mode-btn btn-dark" id="next-question" onclick="nextQuestion()">Next ‚ûú</button>
        <div id="timer-display" style="display:none;"></div>
        <button class="mode-btn btn-red" id="clear-board-btn" style="display:none" onclick="clearBoardMarkers()">üßπ Clear</button>
    </div>

    <div id="key-builder-wrapper">
        <div id="kb-slots"></div>
    </div>

    <div id="mc-options"></div>
    
    <div id="fretboard-wrapper">
        <div id="fretboard-container">
            <div id="fretboard"></div>
        </div>
    </div>

    <div id="cof-wrapper">
        <div class="cof-ring">
            <div id="cof-center-display" class="cof-center">
                Root: <span class="cof-center-note" id="cof-root-note"></span>
            </div>
        </div>
    </div>

    <script>
        /* --- UTILITY & AUDIO --- */
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        function playTone(freq, duration = 1.0, type = 'triangle', gainValue = 0.2) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const now = audioCtx.currentTime;
            const osc = audioCtx.createOscillator();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, now);
            const gain = audioCtx.createGain();
            gain.gain.setValueAtTime(0, now);
            gain.gain.linearRampToValueAtTime(gainValue, now + 0.05); 
            gain.gain.exponentialRampToValueAtTime(0.001, now + duration); 
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start(now);
            osc.stop(now + duration + 0.1);
        }

        // --- FAILURE WAH-WAH (3-note descending tone) ---
        function playFailureWahWah() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const now = audioCtx.currentTime;
            
            // Frequencies for G-F-E descending minor third
            const notes = [
                { f: 196.00, t: now }, // G3
                { f: 174.61, t: now + 0.2 }, // F3
                { f: 164.81, t: now + 0.4 } // E3
            ];
            
            const noteDuration = 0.3;
            
            notes.forEach(note => {
                const osc = audioCtx.createOscillator();
                osc.type = 'triangle';
                osc.frequency.setValueAtTime(note.f, note.t);
                
                const gain = audioCtx.createGain();
                gain.gain.setValueAtTime(0, note.t);
                gain.gain.linearRampToValueAtTime(0.3, note.t + 0.05);
                gain.gain.linearRampToValueAtTime(0.001, note.t + noteDuration);
                
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.start(note.t);
                osc.stop(note.t + noteDuration);
            });
        }

        function calculateFrequency(stringIndex, fret) {
            const openFreq = TUNINGS[currentTuningName][stringIndex];
            return openFreq * Math.pow(2, fret / 12);
        }
        
        // C3 Frequency (Root of Octave 3 - Lowered for Key Builder)
        const C3_FREQ = 130.81; 

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        /* --- DATA --- */
        const NOTES = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
        const NOTES_TO_INDEX = Object.fromEntries(NOTES.map((note, index) => [note, index]));
        const NATURAL_NOTES = ["C", "D", "E", "F", "G", "A", "B"];
        const ACCIDENTAL_NOTES = ["C#", "D#", "F#", "G#", "A#"];
        const ANCHOR_FRETS = [0, 3, 5, 7, 9, 12, 15, 17, 19, 21, 24]; 
        const TUNING_INDICES = { 'standard': [4, 11, 7, 2, 9, 4], 'drop_d': [4, 11, 7, 2, 9, 2], 'dadgad': [2, 9, 7, 2, 9, 2], 'open_g': [2, 11, 7, 2, 7, 2] };
        const TUNINGS = { 'standard': [329.63, 246.94, 196.00, 146.83, 110.00, 82.41], 'drop_d': [329.63, 246.94, 196.00, 146.83, 110.00, 73.42], 'dadgad': [293.66, 220.00, 196.00, 146.83, 110.00, 73.42], 'open_g': [293.66, 246.94, 196.00, 146.83, 98.00, 73.42] };
        const CHORD_INTERVALS = { 'Maj': [0, 4, 7], 'Min': [0, 3, 7], '7': [0, 4, 7, 10] };
        const SCALE_INTERVALS = { 'Major': [0, 2, 4, 5, 7, 9, 11], 'Minor': [0, 2, 3, 5, 7, 8, 10] };
        const SCALE_DEGREES = { 
            'Major': ['I', 'ii', 'iii', 'IV', 'V', 'vi', 'vii¬∞'], 
            'Minor': ['i', 'ii¬∞', 'III', 'iv', 'v', 'VI', 'VII']
        };
        
        // UPGRADED THEORY DATA
        const THEORY = {
            'Free': { concept: "Exploration", strategy: "No rules. Click to hear notes and visualize intervals." },
            'Single': { concept: "Chromatic Scale: 12 unique notes that repeat.", strategy: "Don't count up from 0. Memorize 'Anchor Notes' on dots (Frets 3, 5, 7, 9) and relate nearby notes to them." },
            'Name': { concept: "Pitch Identification.", strategy: "Identify the String first. Add the Fret number to the open string's value. Remember B/C and E/F have no sharp/flat between them." },
            'Maj': { concept: "Major Triad: Root (1) + Major 3rd (3) + Perfect 5th (5).", strategy: "Visual Shape: Looks like a staircase on G-B-E strings. Happy, stable sound." },
            'Min': { concept: "Minor Triad: Root (1) + Minor 3rd (b3) + Perfect 5th (5).", strategy: "Visual Shape: The 3rd is flattened (moved down 1 fret) compared to Major. Sad sound." },
            '7': { concept: "Dominant 7th: Major Triad + Minor 7th (b7).", strategy: "Used in Blues. The 7th is 2 frets behind the octave root." },
            'MajorScale': { concept: "W-W-H-W-W-W-H. The foundation of Western music.", strategy: "Think 3-notes-per-string patterns. The half-steps (H) are between degrees 3-4 and 7-1." },
            'MinorScale': { concept: "W-H-W-W-H-W-W. The Aeolian Mode.", strategy: "The relative minor of a Major scale starts on the 6th degree. H steps are 2-3 and 5-6." },
            'KeyBuilder': { concept: "Interval Construction.", strategy: "Memorize the gaps! Major: Whole, Whole, Half, Whole, Whole, Whole, Half. (Whole = 2 frets/buttons, Half = 1)." },
            'CoF': { concept: "Geometric representation of the 12 keys.", strategy: "Going CW (Sharps): Count up 5 (C->G->D). Going CCW (Flats): Count up 4 or down 5. Mnemonic: BEAD GCF." }
        };
        const COF_ORDER = [0, 7, 2, 9, 4, 11, 6, 1, 8, 3, 10, 5];

        /* --- STATE --- */
        let currentTuningName = 'standard';
        let maxFrets = 12; 
        let currentMode = 'free';
        let targetNotes = []; 
        let baseFret = -1;
        let foundCoordinates = []; 
        let currentSequenceIndex = 0;
        let isQuizActive = false;
        let hintMode = false; 
        let theoryVisible = false;
        let isDarkMode = true; 
        let streak = 0;
        const FRET_SPAN = 4;
        
        let currentReplayFreq = 0;
        let lastPlayedIndex = -1; // NEW: Track last note INDEX (0-11) for stable pitch tracking in builder
        let timerInterval;
        let timerDuration = 0;
        let startTime; 

        // STATS
        let totalQuestions = 0;
        let correctAnswers = 0;
        let totalTimeSpent = 0;
        
        /* --- CORE FUNCTIONS --- */
        function toggleTheme() {
            isDarkMode = !isDarkMode;
            document.body.classList.toggle('dark-mode', isDarkMode);
            const btn = document.getElementById('theme-btn');
            // Logic: üí° = Light Mode is Active. üåë = Dark Mode.
            btn.textContent = isDarkMode ? "üåë" : "üí°"; 
        }

        function toggleTheory() {
            theoryVisible = !theoryVisible;
            const p = document.getElementById('theory-panel');
            const btn = document.getElementById('theory-btn');
            p.style.display = theoryVisible ? 'block' : 'none';
            if(theoryVisible) btn.classList.add('active'); else btn.classList.remove('active');
        }

        function toggleHintMode() {
            hintMode = !hintMode;
            const btn = document.getElementById('hint-btn');
            if(hintMode) btn.classList.add('active'); else btn.classList.remove('active');
            
            // Trigger updates
            if(currentMode === 'cof') updateCofHints();
            else if (currentMode === 'key_builder') highlightBuilderHint();
            else updateHints();
        }

        function updateStatsDisplay() {
            const accuracy = totalQuestions > 0 ? ((correctAnswers / totalQuestions) * 100).toFixed(1) : '--';
            const avgSpeed = correctAnswers > 0 ? (totalTimeSpent / correctAnswers).toFixed(1) : '--';
            document.getElementById('stat-accuracy').textContent = `${accuracy}%`;
            document.getElementById('stat-speed').textContent = `${avgSpeed}s`;
        }
        
        function resetStats() {
            totalQuestions = 0; correctAnswers = 0; totalTimeSpent = 0; streak = 0;
            document.getElementById('streak-display').textContent = '0';
            updateStatsDisplay();
        }
        
        function recordAnswer(isCorrect, timeTaken = 0) {
            if (['single', 'all', 'chord', 'scale', 'name', 'key_builder'].includes(currentMode)) {
                totalQuestions++;
                if (isCorrect) { correctAnswers++; totalTimeSpent += timeTaken; }
                updateStatsDisplay();
            }
        }
        
        function getNote(stringIndex, fret) {
            const openNoteIndex = TUNING_INDICES[currentTuningName][stringIndex];
            return NOTES[(openNoteIndex + fret) % 12];
        }
        
        function changeSetting() {
            currentTuningName = document.getElementById('tuning-select').value;
            maxFrets = parseInt(document.getElementById('range-select').value);
            renderFretboard();
            const modeToStart = (currentMode === 'free' || currentMode === 'cof' || currentMode === 'key_builder') ? 'single' : currentMode;
            if(currentMode !== 'cof' && currentMode !== 'free' && currentMode !== 'key_builder') startQuiz(modeToStart); 
        }

        /* --- RENDERING --- */
        function renderFretboard() {
            const board = document.getElementById('fretboard');
            board.innerHTML = '';
            board.style.gridTemplateColumns = `repeat(${maxFrets + 1}, auto)`;

            for (let f = 0; f <= maxFrets; f++) {
                const col = document.createElement('div');
                col.className = f === 0 ? 'nut-column' : 'fret-column';
                
                if (f > 0) {
                    if ([3, 5, 7, 9, 15, 17, 19, 21].includes(f) && f <= maxFrets) {
                        const m = document.createElement('div'); m.className = 'marker single-marker'; col.appendChild(m);
                    } else if ((f === 12 || f === 24) && f <= maxFrets) {
                        const m1 = document.createElement('div'); m1.className = 'marker double-marker-top'; col.appendChild(m1);
                        const m2 = document.createElement('div'); m2.className = 'marker double-marker-bottom'; col.appendChild(m2);
                    }
                }

                for (let s = 0; s < 6; s++) {
                    const cell = document.createElement('div'); cell.className = `string-cell string-${s}`;
                    const line = document.createElement('div'); line.className = `string-line`; cell.appendChild(line);
                    const spot = document.createElement('div'); spot.className = 'note-spot';
                    spot.setAttribute('data-s', s); spot.setAttribute('data-f', f); 
                    const note = getNote(s, f);
                    spot.setAttribute('data-note', note);
                    if (f === 0) spot.textContent = note;
                    spot.onclick = handleNoteClick;
                    cell.appendChild(spot); col.appendChild(cell);
                }
                board.appendChild(col);
            }
            if(hintMode && currentMode !== 'cof' && currentMode !== 'key_builder') updateHints();
        }

        function renderCofWheel(rootNote, direction) {
            const ring = document.querySelector('#cof-wrapper .cof-ring');
            ring.querySelectorAll('.cof-wedge-container').forEach(c => c.remove()); 
            
            document.getElementById('cof-root-note').textContent = rootNote;
            
            for (let i = 0; i < 12; i++) {
                const noteIndex = COF_ORDER[i];
                const note = NOTES[noteIndex];
                const container = document.createElement('div'); container.className = 'cof-wedge-container';
                container.style.transform = `rotate(${i * 30}deg)`;
                
                const wedge = document.createElement('div'); wedge.className = 'cof-wedge';
                wedge.setAttribute('data-note', note); wedge.onclick = handleCofClick;
                
                const label = document.createElement('div'); label.className = 'cof-note-label'; label.textContent = note;
                const labelRotation = 30 * i + 15; 
                label.style.transform = `rotate(${labelRotation}deg) translate(130px, -10px)`;
                
                container.appendChild(wedge); container.appendChild(label); ring.appendChild(container);
            }
            ring.appendChild(document.getElementById('cof-center-display'));
            if (hintMode) updateCofHints();
        }

        /* --- HINT SYSTEM --- */
        function highlightBuilderHint() {
            // Clear existing
            document.querySelectorAll('.mc-button').forEach(b => b.classList.remove('hint-active'));
            if (!hintMode || !isQuizActive || currentMode !== 'key_builder') return;
            
            // Find next target note
            const nextNote = targetNotes[currentSequenceIndex];
            const btnId = `btn-note-${nextNote.replace('#', 's')}`;
            const btn = document.getElementById(btnId);
            if(btn) btn.classList.add('hint-active');
        }

        function updateCofHints() {
            document.querySelectorAll('.cof-wedge').forEach(w => w.classList.remove('cof-hint'));
            if (hintMode && targetNotes.length > 0) {
                const targetWedge = document.querySelector(`.cof-wedge[data-note="${targetNotes[0]}"]`);
                if (targetWedge) targetWedge.classList.add('cof-hint');
            }
        }
        
        function updateHints() {
            document.querySelectorAll('.note-spot').forEach(s => s.classList.remove('hint-marker'));
            if (!hintMode || !isQuizActive) return;

            // Strategy: Show target notes faintly
            if(currentMode === 'name') {
                // Hint: Highlight the open string note
                 const targetSpot = document.querySelector('.highlighted-question');
                 if(targetSpot) {
                     const s = targetSpot.getAttribute('data-s');
                     const openSpot = document.querySelector(`.note-spot[data-s="${s}"][data-f="0"]`);
                     if(openSpot) openSpot.classList.add('hint-marker');
                 }
            } else {
                // Find/Scale/Chord Hint
                document.querySelectorAll('.note-spot').forEach(s => {
                    const note = s.getAttribute('data-note');
                    const f = parseInt(s.getAttribute('data-f'));
                    // Only hint valid window or all if free
                    let isWindowValid = (baseFret === -1) ? true : (f >= baseFret && f < baseFret + FRET_SPAN) || f===0;
                    
                    if(targetNotes.includes(note) && isWindowValid) {
                        s.classList.add('hint-marker');
                    }
                });
            }
        }

        function setTheoryContent(mode) {
            let key = mode;
            if(mode === 'single' || mode === 'all') key = 'Single';
            if(mode === 'chord') {
                 if(document.getElementById('chord_maj').checked) key = 'Maj'; 
                 // Simple logic: just show first checked or generic
                 else key = 'Maj'; 
            } 
            if(mode === 'scale') key = document.querySelector('input[name="scale_type"]:checked').value + 'Scale';
            if(mode === 'key_builder') key = 'KeyBuilder';
            if(mode === 'cof') key = 'CoF';
            if(mode === 'name') key = 'Name';
            if(mode === 'free') key = 'Free';

            const data = THEORY[key] || THEORY['Free'];
            document.getElementById('theory-title').textContent = (mode === 'key_builder') ? 'Key Construction' : (mode.charAt(0).toUpperCase() + mode.slice(1));
            document.getElementById('theory-concept').textContent = data.concept;
            document.getElementById('theory-strategy').textContent = data.strategy;
        }

        /* --- GAME LOGIC --- */
        function startQuiz(mode) {
            stopTimer();
            clearBoardMarkers();
            currentMode = mode;
            isQuizActive = (mode !== 'free');
            lastPlayedIndex = -1; // Reset last played index for new quiz

            // UI Setup
            document.getElementById('fretboard-wrapper').style.display = 'none';
            document.getElementById('cof-wrapper').style.display = 'none';
            document.getElementById('key-builder-wrapper').style.display = 'none';
            document.getElementById('mc-options').style.display = 'none';
            document.getElementById('replay-btn').style.display = 'none';
            
            // Filter Visibility
            document.querySelectorAll('.filter-group').forEach(g => g.style.display = 'none');
            document.getElementById('clear-board-btn').style.display = 'none';
            
            if(mode === 'name') {
                document.getElementById('name-note-string-filters').style.display = 'flex';
                document.getElementById('timer-setting').style.display = 'flex';
            } else if (mode === 'chord') {
                document.getElementById('chord-filters').style.display = 'flex';
            } else if (mode === 'scale' || mode === 'key_builder') {
                document.getElementById('scale-filters').style.display = 'flex';
            }
            if(mode === 'key_builder') document.getElementById('timer-setting').style.display = 'flex';

            setTheoryContent(mode);
            foundCoordinates = [];
            currentSequenceIndex = 0;
            targetNoteIndex = Math.floor(Math.random() * 12);
            const rootNote = NOTES[targetNoteIndex];

            // --- MODE SWITCH ---
            if (mode === 'free') {
                document.getElementById('fretboard-wrapper').style.display = 'flex';
                document.getElementById('clear-board-btn').style.display = 'block';
                document.getElementById('target-note-display').textContent = "Free Play";
                document.getElementById('message-display').textContent = "Click notes.";
                return;
            }

            if (mode === 'cof') {
                document.getElementById('cof-wrapper').style.display = 'flex';
                const direction = Math.random() < 0.5 ? 'Up' : 'Down';
                const offset = direction === 'Up' ? 7 : 5;
                const targetIdx = (NOTES.indexOf(rootNote) + offset) % 12;
                targetNotes = [NOTES[targetIdx]];
                
                document.getElementById('target-note-display').textContent = `${rootNote} ‚Æï 5th ${direction}?`;
                document.getElementById('message-display').textContent = direction === 'Up' ? "Clockwise (Sharp direction)" : "Counter-Clockwise (Flat direction)";
                renderCofWheel(rootNote, direction);
                return;
            }

            if (mode === 'key_builder') {
                document.getElementById('key-builder-wrapper').style.display = 'flex';
                document.getElementById('mc-options').style.display = 'grid';
                
                const scaleType = document.querySelector('input[name="scale_type"]:checked').value; 
                targetNotes = SCALE_INTERVALS[scaleType].map(i => NOTES[(targetNoteIndex + i) % 12]);
                
                document.getElementById('target-note-display').textContent = `Build ${rootNote} ${scaleType}`;
                document.getElementById('message-display').textContent = "Select intervals in order.";
                
                // Set last played index to the root note (used for ascending logic)
                lastPlayedIndex = NOTES_TO_INDEX[rootNote];
                
                // Render Slots
                const slotsDiv = document.getElementById('kb-slots');
                slotsDiv.innerHTML = '';
                SCALE_DEGREES[scaleType].forEach((deg, i) => {
                    const slot = document.createElement('div');
                    slot.className = 'kb-slot';
                    slot.id = `kb-slot-${i}`;
                    slot.innerHTML = `<span class="kb-note">?</span><span class="kb-degree">${deg}</span>`;
                    slotsDiv.appendChild(slot);
                });
                document.getElementById('kb-slot-0').classList.add('active-target');
                
                // Render MC Buttons (Chromatic)
                const mcDiv = document.getElementById('mc-options');
                mcDiv.innerHTML = '';
                NOTES.forEach(n => {
                    const btn = document.createElement('button');
                    btn.className = 'mc-button';
                    btn.textContent = n;
                    btn.setAttribute('data-answer', n);
                    btn.id = `btn-note-${n.replace('#', 's')}`;
                    btn.onclick = handleBuilderClick;
                    mcDiv.appendChild(btn);
                });
                
                startTime = Date.now();
                startTimer();
                highlightBuilderHint();
                return;
            }

            // Fretboard Modes
            document.getElementById('fretboard-wrapper').style.display = 'flex';
            baseFret = -1;
            
            if (mode === 'name') {
                const s = Math.floor(Math.random() * 6);
                const f = Math.floor(Math.random() * (maxFrets+1));
                const note = getNote(s, f);
                targetNotes = [note];
                currentReplayFreq = calculateFrequency(s, f);
                document.getElementById('replay-btn').style.display = 'block';
                document.getElementById('mc-options').style.display = 'grid';
                
                document.getElementById('target-note-display').textContent = "?";
                document.getElementById('message-display').textContent = "Identify the highlighted note.";
                
                // Highlight Spot
                const spot = document.querySelector(`.note-spot[data-s="${s}"][data-f="${f}"]`);
                if (spot) { spot.classList.add('highlighted-question'); spot.style.pointerEvents = 'none'; }
                playTone(currentReplayFreq);
                
                // MC Buttons (Random 4)
                const mcDiv = document.getElementById('mc-options');
                mcDiv.innerHTML = '';
                let opts = [note, ...generateDistractors(NOTES.indexOf(note))];
                shuffleArray(opts);
                opts.forEach(n => {
                    const btn = document.createElement('button');
                    btn.className = 'mc-button';
                    btn.textContent = n;
                    btn.setAttribute('data-answer', n);
                    btn.onclick = handleMcAnswer;
                    mcDiv.appendChild(btn);
                });
            } else {
                // Single/Scale/Chord/All
                if (mode === 'single' || mode === 'all') {
                    targetNotes = [rootNote];
                    document.getElementById('target-note-display').textContent = rootNote;
                    document.getElementById('message-display').textContent = mode === 'single' ? "Find ONE instance." : "Find ALL instances.";
                } else {
                    // Chord/Scale
                    const type = mode === 'chord' ? 'Maj' : document.querySelector('input[name="scale_type"]:checked').value;
                    // For demo simplicity, defaulting chord to Major if not specific logic used
                    targetNotes = (mode==='chord'?CHORD_INTERVALS['Maj']:SCALE_INTERVALS[type]).map(i => NOTES[(targetNoteIndex + i) % 12]);
                    baseFret = Math.floor(Math.random() * (maxFrets - FRET_SPAN));
                    document.getElementById('target-note-display').textContent = `${rootNote} ${type}`;
                    document.getElementById('message-display').textContent = `Range: Frets ${baseFret}-${baseFret+3}`;
                }
            }
            
            startTime = Date.now();
            updateHints();
        }

        /* --- EVENT HANDLERS --- */
        function handleBuilderClick(e) {
            if(!isQuizActive) return;
            const btn = e.currentTarget;
            const selected = btn.getAttribute('data-answer');
            const correct = targetNotes[currentSequenceIndex];
            
            const selectedNoteIndex = NOTES_TO_INDEX[selected];
            
            // Calculate frequency based on C3 (130.81 Hz - Lowered for Key Builder)
            let freq = C3_FREQ * Math.pow(2, selectedNoteIndex / 12);
            
            // Pitch logic: Keep the note in the same octave (C3-B3) unless it's the first note
            if (currentSequenceIndex > 0) {
                // If the selected note (e.g., C) has a lower index than the previous note (e.g., B), 
                // it means we have crossed the octave boundary and need to jump up one octave (C4).
                if (selectedNoteIndex <= lastPlayedIndex) {
                    freq *= 2; 
                }
            }
            
            // Update last played index for the next check
            lastPlayedIndex = selectedNoteIndex;

            if(selected === correct) {
                // Correct
                btn.classList.add('kb-selected');
                const slot = document.getElementById(`kb-slot-${currentSequenceIndex}`);
                slot.classList.add('filled');
                slot.querySelector('.kb-note').textContent = selected;
                slot.classList.remove('active-target');
                
                playTone(freq, 0.4, 'sine', 0.5); // Use SINE wave for a guitar-like tone
                
                currentSequenceIndex++;
                if(currentSequenceIndex >= targetNotes.length) {
                    document.querySelectorAll('.mc-button').forEach(b => { b.classList.remove('kb-selected'); b.classList.add('kb-right'); });
                    winRound((Date.now() - startTime)/1000);
                } else {
                    document.getElementById(`kb-slot-${currentSequenceIndex}`).classList.add('active-target');
                    highlightBuilderHint();
                }
            } else {
                btn.classList.add('kb-wrong');
                loseRound();
            }
        }
        
        function handleMcAnswer(e) {
            if(!isQuizActive) return;
            const selected = e.currentTarget.getAttribute('data-answer');
            if(selected === targetNotes[0]) {
                e.currentTarget.classList.add('correct-answer');
                winRound((Date.now() - startTime)/1000);
            } else {
                e.currentTarget.classList.add('wrong-answer');
                loseRound();
            }
        }

        function handleNoteClick(e) {
            if(currentMode === 'free') {
                const s = e.currentTarget;
                playTone(calculateFrequency(s.getAttribute('data-s'), s.getAttribute('data-f')));
                s.classList.add('correct'); setTimeout(()=>s.classList.remove('correct'), 300);
                return;
            }
            if(!isQuizActive || currentMode === 'name') return;
            
            const spot = e.currentTarget;
            const note = spot.getAttribute('data-note');
            playTone(calculateFrequency(spot.getAttribute('data-s'), spot.getAttribute('data-f')));

            // Validation
            let isValid = targetNotes.includes(note);
            // Check Scale Order
            if(currentMode === 'scale' && isValid) {
                 isValid = (note === targetNotes[currentSequenceIndex % 7]);
            }
            // Check Fret Window
            if(baseFret > -1) {
                const f = parseInt(spot.getAttribute('data-f'));
                if(f !== 0 && (f < baseFret || f >= baseFret + FRET_SPAN)) isValid = false;
            }
            
            spot.textContent = note;
            if(isValid) {
                spot.classList.add(currentMode === 'scale' ? 'sequence-correct' : 'correct');
                spot.style.pointerEvents = 'none';
                
                if(currentMode === 'single') winRound((Date.now() - startTime)/1000);
                else if (currentMode === 'scale') {
                    currentSequenceIndex++;
                    if(currentSequenceIndex >= 7) winRound((Date.now() - startTime)/1000);
                }
                else if (currentMode === 'all') {
                    // Simple "find enough" logic
                    foundCoordinates.push(spot);
                    if(foundCoordinates.length >= 2) winRound((Date.now() - startTime)/1000); // reduced threshold for demo
                }
            } else {
                spot.classList.add('incorrect');
                loseRound();
            }
        }

        function handleCofClick(e) {
            if(!isQuizActive) return;
            if(e.currentTarget.getAttribute('data-note') === targetNotes[0]) {
                e.currentTarget.classList.add('cof-correct');
                winRound();
            } else {
                e.currentTarget.classList.add('cof-incorrect');
                loseRound();
            }
        }

        /* --- END GAME --- */
        function winRound(time) {
            isQuizActive = false; streak++;
            document.getElementById('streak-display').textContent = streak;
            document.getElementById('message-display').textContent = "Excellent! ü§ò";
            document.getElementById('message-display').style.color = "var(--highlight-green)";
            recordAnswer(true, time);
            document.querySelectorAll('.mc-button').forEach(b => b.onclick = null);

            if(currentMode === 'key_builder') {
                revealKeyBuilderNotes();
            }
        }

        function loseRound() {
            isQuizActive = false; streak = 0;
            document.getElementById('streak-display').textContent = streak;
            document.getElementById('message-display').textContent = "Incorrect. Wah-wah...";
            document.getElementById('message-display').style.color = "var(--highlight-orange)";
            recordAnswer(false);
            
            // **FAILURE WAH-WAH**
            playFailureWahWah();
            lastPlayedIndex = -1; // Reset octave tracking on failure

            if(currentMode === 'key_builder') {
                revealKeyBuilderNotes();
            }
            
            if(currentMode === 'name') {
                document.querySelectorAll('.mc-button').forEach(b => {
                    if(b.getAttribute('data-answer') === targetNotes[0]) b.classList.add('revealed-answer');
                });
            }
        }
        
        function revealKeyBuilderNotes() {
             // 1. Fill the slots with correct notes and color them green
            targetNotes.forEach((note, i) => {
                const slot = document.getElementById(`kb-slot-${i}`);
                if (slot) {
                    slot.classList.remove('filled', 'active-target');
                    slot.classList.add('correct-reveal');
                    slot.querySelector('.kb-note').textContent = note;
                }
            });

            // 2. Highlight missed buttons (only applies if failed)
            document.querySelectorAll('.mc-button').forEach(btn => {
                const note = btn.getAttribute('data-answer');
                const isCorrectNote = targetNotes.includes(note);
                const wasSelected = btn.classList.contains('kb-selected') || btn.classList.contains('kb-wrong');

                btn.onclick = null; // Disable further clicking

                if (isCorrectNote && !wasSelected) {
                    // Missed note that was part of the key
                    btn.classList.remove('kb-selected', 'kb-right', 'kb-wrong');
                    btn.classList.add('kb-missed');
                } else if (!isCorrectNote && wasSelected) {
                    // Wrong note that was selected (already handled by kb-wrong)
                } else if (isCorrectNote && wasSelected) {
                    // Correct note that was selected (already handled by kb-right)
                }
            });
        }

        function nextQuestion() {
            startQuiz(currentMode === 'free' ? 'single' : currentMode);
        }
        
        function clearBoardMarkers() {
            document.querySelectorAll('.note-spot').forEach(s => {
               s.classList.remove('correct','incorrect','revealed','sequence-correct','hint-marker','highlighted-question');
               s.style.pointerEvents = 'auto';
               if(s.getAttribute('data-f')!=='0') s.textContent='';
            });
            document.querySelectorAll('.cof-wedge').forEach(w => w.classList.remove('cof-correct','cof-incorrect','cof-hint'));
        }
        
        function replayTargetTone() { if(currentReplayFreq) playTone(currentReplayFreq); }
        function resetTimer() { 
            // Simplified for this snippet length, assumed working from previous versions
            if(isQuizActive) startTimer(); 
        }
        function startTimer() { 
            // Simplified for this snippet length, assumed working from previous versions
        }
        function stopTimer() { clearInterval(timerInterval); document.getElementById('timer-display').textContent = ''; }
        function generateDistractors(idx) {
            return [(idx+1)%12, (idx+11)%12, (idx+7)%12].map(i => NOTES[i]);
        }
        
        // Init
        window.onload = () => { renderFretboard(); }
    </script>
</body>
</html>
